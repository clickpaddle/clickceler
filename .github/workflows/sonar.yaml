name: SonarQube Analysis

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarqube_analysis:
    name: SonarScan
    runs-on: arc-runner-set
    permissions:
      id-token: write  
      contents: read   
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Crucial pour Sonar : permet d'analyser l'historique et les auteurs

      - name: Import Secrets from HashiCorp Vault
        uses: hashicorp/vault-action@v2
        with:
          url: https://vault
          role: github-actions-role
          method: jwt
          kvVersion: 2
          secrets: |
            applications/prod/sonarqube/github-actions#token|SONAR_TOKEN
            applications/prod/sonarqube/github-actions#host_url|SONAR_HOST_URL 
          tlsSkipVerify: true        # <-- ne pas vÃ©rifier le certificat
          kubernetesTokenPath: /var/run/secrets/kubernetes.io/serviceaccount/token
          exportEnv: true
          exportToken: false
          outputToken: false
          jwtTtl: 3600
          ignoreNotFound: false
            

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
           args: >
             "-Dsonar.sources=."
             "-Dsonar.inclusions=**/*.c,**/*.pl,**/*.py,**/*.yaml,**/*.yml"
             "-Dsonar.projectName=Clickceler"
             "-Dsonar.projectKey=clickceler"
             "-Dsonar.sourceEncoding=UTF-8"


  build_job:
    name: Build Application
    needs: sonarqube_analysis # Indique que ce job attend la fin de Sonar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Build
        run: echo "Build can start now, Sonar scan is done"
